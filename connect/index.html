<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Weevil Connect for We Vibe">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet">
    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/materialize.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/custom.css">

    <!-- Origin Trial Token, feature = Web Bluetooth, origin = https://privateplayaccord.github.io, expires = 2016-11-09 -->
    <meta http-equiv="origin-trial" data-feature="Web Bluetooth" data-expires="2016-11-09" content="AlMDcCxNiNccAHyzfULM3N7kRmIZFsYBUK1eOMdF71OOD/wpBHj4Z2YwycKAzU34xXj7eA5aGhhemgCj9XC7QwMAAABmeyJvcmlnaW4iOiAiaHR0cHM6Ly9wcml2YXRlcGxheWFjY29yZC5naXRodWIuaW86NDQzIiwgImZlYXR1cmUiOiAiV2ViQmx1ZXRvb3RoIiwgImV4cGlyeSI6IDE0Nzg2OTgxMTl9">

    <title>Weevil Connect for We Vibe</title>
  </head>

  <body>

      <!-- HEADER -->
      <header class="center-align">
        <div class="container">
          <img src="images/weevil.svg" class="logo"/>
          <h1 id="project_title">Weevil Connect for We Vibe</h1>
          <h2 id="project_tagline"></h2>
        </div>
      </header>

      <main>

        <div class="container">
        <!-- MAIN CONTENT -->
        <div id="main_content_wrap" class="center-align">
          <section id="main_content" class="main-actions">
            <button id="btn_request_device" class="btn-large pink darken-1">
              <i class="material-icons">&#xE335;</i>
              Pair device
            </button>
            <button id="btn_sync_pulse" class="btn-large pink darken-2">
              <i class="material-icons">&#xE627;</i>
              Sync Pulse
            </button>
            <button id="btn_read_data" class="btn-large pink darken-3">
              <i class="material-icons">&#xE896;</i>
              Read Data
            </button>
            <div id="info-wrapper" style="display:none;">
              <p id="info"> </p>
            </div>
            <div>
              <h2>Select mode</h2>
              <select id="selectBox" class="btn dropdown-toggle pink darken-4" placeholder="Select mode" onchange="changePattern(value);">
                <option value="none">None</option>
                <option value="chachacha">Chachacha</option>
                <option value="vibrate">Vibrate</option>
                <option value="other">Other</option>
              </select>
            </div>
          </section>
        </div>
      <script>

        // Initial class generated by: <https://beaufortfrancois.github.io/sandbox/web-bluetooth/generator/>
        // Other references:
        //  * <https://googlechrome.github.io/samples/web-bluetooth/device-info.html>
        //  * <https://googlechrome.github.io/samples/web-bluetooth/reset-energy.html>

        class WeVibe {
        
          constructor() {
            this.device = null;
            this.onDisconnected = this.onDisconnected.bind(this);
            console.log(":D");
          }
        
          request() {
            let options = {
                          "filters": [{
                "services": ["0000bb03-0000-1000-8000-00805f9b34fb"]
              }],
              "optionalServices": ["f000bb03-0451-4000-b000-000000000000"]
            };
            return navigator.bluetooth.requestDevice(options)
            .then(device => {
              this.device = device;
              this.device.addEventListener('gattserverdisconnected', this.onDisconnected);
              return device;
            });
          }
        
          connect() {
            if (!this.device) {
              return Promise.reject('Device is not connected.');
            } else {
              return this.device.gatt.connect();
              
            }
          }
          
          readInfo() {
            return this.device.gatt.getPrimaryService("f000bb03-0451-4000-b000-000000000000")
            .then(service => service.getCharacteristic("f000b000-0451-4000-b000-000000000000"))
            .then(characteristic => characteristic.readValue());
          }
          
          writeCommand(data) {
            return this.device.gatt.getPrimaryService("f000bb03-0451-4000-b000-000000000000")
            .then(service => service.getCharacteristic("f000c000-0451-4000-b000-000000000000"))
            .then(characteristic => characteristic.writeValue(data));
          }
          
          disconnect() {
            if (!this.device) {
              return Promise.reject('Device is not connected.');
            } else {
              return this.device.gatt.disconnect();
            }
          }
        
          onDisconnected() {
            console.log('Device is disconnected.');
          }
        }

        var weVibe = new WeVibe();

        document.querySelector('#btn_request_device').addEventListener('click', function() {
          if (!navigator.bluetooth) {
            alert("No Bluetooth. :(");
            return;
          }

          // TODO: Deactive other buttons until this succeeds?
          weVibe.request();
        });

        document.querySelector('#btn_sync_pulse').addEventListener('click', function() {

          weVibe.connect()
          .then(_ => {return weVibe.writeCommand(new Uint8Array([30, 32, 45, 0, 0, 0, 0, 0]));})
          //.then(_ => weVibe.disconnect())
          .catch(error => { console.log(error) });
        });
        
        document.querySelector('#btn_read_data').addEventListener('click', function() {
          

          weVibe.connect()
          .then(_ => {return weVibe.writeCommand(new Uint8Array([15, 255, 0, 100, 0, 0, 0, 0]))})
          .then(_ => {return weVibe.readInfo()})
          .then(result => {displayInfo(result)})
          //.then(_ => weVibe.disconnect())
          .catch(error => { console.log(error) });


          //});
        });

  function displayInfo(readInfoResponse) {
	 var deviceStatus = readInfoResponse;

	 var mode = deviceStatus.getUint8(1) & 0xf;
	 var temp = Math.round((deviceStatus.getUint8(5)-32)*5/9);

	 var j = (deviceStatus.getUint8(3) << 8) + deviceStatus.getUint8(2) & 0xffff;
         var i = j;
         if (j < 0) {
           i = 0x10000 + j;
         }
	 var battery = Math.round((i / 65535) * 100);

	 var model = "unknown";
	 if (deviceStatus.getUint8(7) == 69) {
	   model = "We-Vibe 4+";
	 }

         var extIntensity = deviceStatus.getUint8(6)  >> 4 & 0xf;
	 var intIntensity = deviceStatus.getUint8(6) & 0xf;

         document.getElementById('info-wrapper').style.display = ""
         document.getElementById('info').innerHTML = "<h3><span>Temperature: " + temp + "&deg;C</span></h3><h3><span>Battery: " + battery + "%</span></h3>";
  }
    
  function changePattern(pattern)  {
    command = null;
  if (pattern == "none")
    command = new Uint8Array([15, 0, null, 0, null, null, null, null]);
   else if (pattern == "chachacha")
    command = new Uint8Array([15, 9, null, 0, null, null, null, null]); 
    else if (pattern == "vibrate")
    command = new Uint8Array([15, 1, null, 0, null, null, null, null]); 
     else if (pattern == "other")
    command = new Uint8Array([15, 2, null, 0, null, null, null, null]); 
     weVibe.connect()
          .then(_ => {return weVibe.writeCommand(command);})
          //.then(_ => weVibe.disconnect())
          .catch(error => { console.log(error) });
  }

        </script>

      </div>

    </main>
  </body>
</html>
